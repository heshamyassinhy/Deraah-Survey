<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø¯Ø±Ø¹Ù‡ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 28px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        /* Ø²ÙˆÙ… Ø®ÙÙŠÙ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© */
        .chart-zoom-area {
            transition: transform 0.4s ease;
        }
        .chart-zoom-area:hover {
            transform: scale(1.03);
        }
        .sidebar {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .custom-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .comment-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        select option {
            background: #1e293b;
            color: white;
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <aside class="sidebar w-64 fixed h-full hidden lg:block z-50">
        <div class="p-8">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center font-bold text-white shadow-lg shadow-emerald-500/20 text-2xl">D</div>
                <div>
                    <h1 class="text-xl font-bold leading-none">Ø¯Ø±Ø¹Ù‡</h1>
                    <p class="text-[10px] text-emerald-500 tracking-widest mt-1">ACADEMY</p>
                </div>
            </div>
            
            <nav class="space-y-4">
                <p class="text-[10px] text-slate-500 font-bold px-4 mb-2 uppercase tracking-widest">Ø§Ù„Ø£Ø¯ÙˆØ§Øª</p>
                
                <button onclick="exportReport()" class="w-full flex items-center gap-3 px-5 py-3 rounded-xl bg-white/5 hover:bg-emerald-500/20 text-xs text-slate-300 transition-all text-right">
                    ğŸ“Š ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„
                </button>

                <button onclick="showExcluded()" class="w-full flex items-center gap-3 px-5 py-3 rounded-xl bg-white/5 hover:bg-amber-500/20 text-xs text-slate-300 transition-all text-right">
                    ğŸš« Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†
                </button>

                <div class="pt-6">
                    <p class="text-[10px] text-slate-500 font-bold px-4 mb-2 uppercase tracking-widest">Ø§Ù„Ø¨Ø­Ø«</p>
                    <input type="text" id="userSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-xs focus:outline-none focus:border-emerald-500 transition-all text-white">
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 lg:mr-64 p-6 lg:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
                <h2 class="text-3xl font-bold tracking-tight">ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡</h2>
                <p class="text-slate-400 mt-2 flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ù„Ù„Ø§ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©
                </p>
            </div>
            <div class="flex gap-4 w-full md:w-auto">
                <label for="fileInput" class="custom-button w-full md:w-auto px-8 py-4 rounded-2xl font-bold cursor-pointer flex items-center justify-center gap-3 text-white shadow-lg shadow-emerald-500/20">
                    Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                </label>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</p><h3 id="totalResponses" class="text-4xl font-black">0</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨</p><h3 id="instructorScore" class="text-4xl font-black text-emerald-400">0%</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p><h3 id="contentScore" class="text-4xl font-black text-blue-400">0%</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø±Ø¶Ø§ Ø§Ù„Ù…Ù†ØµØ©</p><h3 id="uxScore" class="text-4xl font-black text-amber-500">0%</h3></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 items-stretch">
            <div class="glass-card p-8 min-h-[500px]">
                <h4 class="font-bold text-lg mb-8">Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…</h4>
                <div class="relative flex-1 flex items-center justify-center chart-zoom-area">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-8 min-h-[500px]">
                <h4 class="font-bold text-lg mb-6 flex justify-between">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span>ğŸ”</span></h4>
                <div id="detailedAnalysisList" class="space-y-3 flex-1 overflow-y-auto pr-2">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙˆØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø³ÙŠØ£Ø®Ø° Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ -->
                </div>
            </div>
        </div>

        <!-- Comments Section Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <h4 class="text-xl font-bold">Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
            <div class="flex items-center gap-3">
                <span class="text-xs text-slate-500">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</span>
                <select id="commentSort" class="bg-slate-800 border border-white/10 rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-emerald-500 text-white cursor-pointer hover:bg-slate-700 transition-colors">
                    <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                    <option value="old">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
                    <option value="long">Ø§Ù„Ø£Ø·ÙˆÙ„ (Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹)</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card p-8">
                <h4 class="text-emerald-400 font-bold mb-6 flex justify-between">ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø¨ <span id="instCommCount" class="text-xs opacity-50 font-normal pt-1">0</span></h4>
                <div id="instructorComments" class="space-y-4 max-h-[450px] overflow-y-auto pl-2"></div>
            </div>
            <div class="glass-card p-8">
                <h4 class="text-blue-400 font-bold mb-6 flex justify-between">ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© <span id="courseCommCount" class="text-xs opacity-50 font-normal pt-1">0</span></h4>
                <div id="courseComments" class="space-y-4 max-h-[450px] overflow-y-auto pl-2"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="excludedModal" class="modal">
        <div class="glass-card max-w-xl w-full p-8 relative">
            <button onclick="closeModal('excludedModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-2xl">Ã—</button>
            <h3 class="text-xl font-bold mb-6 text-amber-500">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ† (Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©)</h3>
            <div id="excludedList" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="commentModal" class="modal">
        <div class="glass-card max-w-xl w-full p-10 relative">
            <button onclick="closeModal('commentModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-3xl">Ã—</button>
            <div class="flex items-center gap-5 mb-8">
                <div id="modalUserAvatar" class="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center font-bold text-2xl">ØŸ</div>
                <div><h3 id="modalUserName" class="text-2xl font-bold">...</h3><p id="modalDate" class="text-emerald-500 text-sm"></p></div>
            </div>
            <div class="bg-white/5 p-8 rounded-3xl border border-white/10">
                <p id="modalCommentContent" class="text-slate-200 text-xl leading-relaxed whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <div id="lowScoresModal" class="modal">
        <div class="glass-card max-w-lg w-full p-8 relative">
            <button onclick="closeModal('lowScoresModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-3xl">Ã—</button>
            <h3 id="lowScoreTitle" class="text-xl font-bold mb-6 text-emerald-400">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¨ÙŠØ§Øª (1 - 3)</h3>
            <div id="lowScoresList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        let mainChart;
        let cleanData = [];
        let excludedUsers = [];
        let rawDataForComments = [];
        let globalMap = {};
        let lastHeaders = [];

        const columnKeywords = {
            name: ["name", "Ø§Ù„Ø§Ø³Ù…"],
            ux: ["Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡", "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"],
            hours: ["Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©"],
            vids: ["Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª", "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰"],
            book: ["ÙƒØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±Ø©"],
            assets: ["Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"],
            exam: ["ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"],
            apply: ["ØªØ·Ø¨ÙŠÙ‚ Ù…Ø§ ØªØ¹Ù„Ù…ØªÙ‡"],
            methods: ["Ø§Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙÙ‡", "Ø£Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙØ©", "Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø©"],
            clarity: ["ÙˆØ¶ÙˆØ­ Ø´Ø±Ø­ Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            voice: ["ØµÙˆØªÙ‡ Ø¨Ø´ÙƒÙ„ ÙØ¹Ø§Ù„"],
            link: ["Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"],
            recommend: ["ØªÙˆØµÙŠ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            improveCourse: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ø¯ÙˆØ±Ø§Øª"],
            improveInst: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ù…Ø¯Ø±Ø¨"],
            date: ["date", "Ø§Ù„ØªØ§Ø±ÙŠØ®"]
        };

        const instructorKeys = ['methods', 'clarity', 'voice', 'link', 'recommend'];
        const contentKeys = ['hours', 'vids', 'book', 'assets', 'exam', 'apply'];
        const allRatingKeys = ['ux', ...instructorKeys, ...contentKeys];

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                processFile(json);
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('commentSort').addEventListener('change', renderComments);

        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || "").toString().toLowerCase();
                if (keywords.some(kw => header.includes(kw.toLowerCase()))) return i;
            }
            return -1;
        }

        function processFile(rows) {
            if (rows.length < 2) return;
            lastHeaders = rows[0];
            const dataRows = rows.slice(1);
            rawDataForComments = dataRows;

            Object.keys(columnKeywords).forEach(key => {
                globalMap[key] = findColumnIndex(lastHeaders, columnKeywords[key]);
            });

            cleanData = [];
            excludedUsers = [];

            dataRows.forEach(row => {
                let isMissing = allRatingKeys.some(key => {
                    const idx = globalMap[key];
                    if (idx === -1) return false;
                    const val = row[idx];
                    return val === undefined || val === null || val.toString().trim() === "" || val.toString() === "0";
                });

                if (isMissing) {
                    excludedUsers.push({
                        name: row[globalMap.name] || "Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                        row: row
                    });
                } else {
                    cleanData.push(row);
                }
            });

            renderUI();
        }

        function calculatePercentage(data, keys) {
            let totalPossible = data.length * keys.length;
            let positive = 0;
            keys.forEach(key => {
                const idx = globalMap[key];
                if (idx !== -1) {
                    data.forEach(row => { if (parseInt(row[idx]) >= 4) positive++; });
                }
            });
            return totalPossible > 0 ? ((positive / totalPossible) * 100).toFixed(1) : 0;
        }

        function renderUI() {
            document.getElementById('totalResponses').innerText = cleanData.length;
            
            const iScore = calculatePercentage(cleanData, instructorKeys);
            const cScore = calculatePercentage(cleanData, contentKeys);
            const uScore = calculatePercentage(cleanData, ['ux']);

            document.getElementById('instructorScore').innerText = iScore + "%";
            document.getElementById('contentScore').innerText = cScore + "%";
            document.getElementById('uxScore').innerText = uScore + "%";

            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ø§Ù„Ù…Ø¯Ø±Ø¨', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'Ø§Ù„Ù…Ù†ØµØ©'],
                    datasets: [{
                        data: [iScore, cScore, uScore],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: { 
                    cutout: '70%', 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: 'Cairo', size: 12 } } } },
                    animation: { animateScale: true }
                }
            });

            const list = document.getElementById('detailedAnalysisList');
            list.innerHTML = '';
            allRatingKeys.forEach(key => {
                const score = calculatePercentage(cleanData, [key]);
                const title = lastHeaders[globalMap[key]] || key;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-all';
                div.innerHTML = `
                    <div class="flex-1 ml-4 overflow-hidden">
                        <p class="text-xs text-slate-400 truncate">${title}</p>
                        <div class="w-full bg-white/10 h-1.5 rounded-full mt-2">
                            <div class="h-full rounded-full ${score > 80 ? 'bg-emerald-500' : 'bg-amber-500'}" style="width: ${score}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold">${score}%</span>
                        <button onclick="showLowScores('${key}', '${title}')" class="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500 hover:text-white transition-all text-[10px]">ÙØ­Øµ</button>
                    </div>
                `;
                list.appendChild(div);
            });

            renderComments();
        }

        function renderComments() {
            const sortVal = document.getElementById('commentSort').value;
            const instEl = document.getElementById('instructorComments');
            const courseEl = document.getElementById('courseComments');
            instEl.innerHTML = ''; courseEl.innerHTML = '';
            
            let allComments = [];
            rawDataForComments.forEach(row => {
                const name = row[globalMap.name] || "Ù…ØªØ¯Ø±Ø¨";
                const date = row[globalMap.date] || "";
                const iC = row[globalMap.improveInst];
                const cC = row[globalMap.improveCourse];

                if (iC && iC.toString().trim().length > 1 && iC != "0") {
                    allComments.push({ text: iC.toString(), name, date, row, type: 'inst' });
                }
                if (cC && cC.toString().trim().length > 1 && cC != "0") {
                    allComments.push({ text: cC.toString(), name, date, row, type: 'course' });
                }
            });

            // Sorting logic
            if (sortVal === 'new') allComments.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (sortVal === 'old') allComments.sort((a, b) => new Date(a.date) - new Date(b.date));
            else if (sortVal === 'long') allComments.sort((a, b) => b.text.length - a.text.length);

            let iCount = 0, cCount = 0;
            allComments.forEach(c => {
                const card = createCommentCard(c.text, c.name, c.row);
                if (c.type === 'inst') { instEl.appendChild(card); iCount++; }
                else { courseEl.appendChild(card); cCount++; }
            });

            document.getElementById('instCommCount').innerText = iCount;
            document.getElementById('courseCommCount').innerText = cCount;
        }

        function createCommentCard(text, name, row) {
            const div = document.createElement('div');
            div.className = 'comment-card p-5 rounded-2xl cursor-pointer hover:border-emerald-500/40 transition-all';
            div.setAttribute('data-name', name);
            div.innerHTML = `<p class="text-sm text-slate-300 line-clamp-2">${text}</p><div class="flex justify-between mt-3 opacity-40 text-[10px]"><span>${name}</span><span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span></div>`;
            div.onclick = () => openUserDetail(row);
            return div;
        }

        function showExcluded() {
            const list = document.getElementById('excludedList');
            list.innerHTML = '';
            if (excludedUsers.length === 0) list.innerHTML = '<p class="text-center py-10 opacity-30">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ¨Ø¹Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
            
            excludedUsers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-white/5 rounded-xl border border-white/5 flex justify-between items-center';
                div.innerHTML = `<span class="text-sm">${item.name}</span><span class="text-[10px] text-amber-500">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©</span>`;
                list.appendChild(div);
            });
            document.getElementById('excludedModal').style.display = 'flex';
        }

        function exportReport() {
            if (cleanData.length === 0) return;
            
            const summary = [
                ["ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡"],
                ["ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±", new Date().toLocaleString()],
                ["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", cleanData.length],
                ["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†", excludedUsers.length],
                [],
                ["Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…"],
                ["Ø§Ù„Ù…Ø¯Ø±Ø¨", document.getElementById('instructorScore').innerText],
                ["Ø§Ù„Ù…Ø­ØªÙˆÙ‰", document.getElementById('contentScore').innerText],
                ["Ø§Ù„Ù…Ù†ØµØ©", document.getElementById('uxScore').innerText],
                [],
                ["ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ"],
                ["Ø§Ù„Ø³Ø¤Ø§Ù„", "Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©"]
            ];

            allRatingKeys.forEach(key => {
                const title = lastHeaders[globalMap[key]] || key;
                summary.push([title, calculatePercentage(cleanData, [key]) + "%"]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ");
            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø¯Ø±Ø¹Ù‡_${new Date().getTime()}.xlsx`);
        }

        function showLowScores(key, title) {
            const idx = globalMap[key];
            const listEl = document.getElementById('lowScoresList');
            listEl.innerHTML = '';
            
            const lowScorers = cleanData
                .map(r => ({ name: r[globalMap.name], val: parseInt(r[idx]), row: r }))
                .filter(item => item.val <= 3)
                .sort((a, b) => a.val - b.val);

            if (lowScorers.length === 0) listEl.innerHTML = '<p class="text-center py-10 opacity-40">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©.</p>';

            lowScorers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10';
                div.onclick = () => { closeModal('lowScoresModal'); openUserDetail(item.row); };
                div.innerHTML = `<span>${item.name}</span><span class="bg-red-500/20 text-red-500 px-3 py-1 rounded-lg font-bold">${item.val}</span>`;
                listEl.appendChild(div);
            });
            document.getElementById('lowScoresModal').style.display = 'flex';
        }

        function openUserDetail(row) {
            const iC = row[globalMap.improveInst] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
            const cC = row[globalMap.improveCourse] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
            document.getElementById('modalUserName').innerText = row[globalMap.name] || "Ù…ØªØ¯Ø±Ø¨";
            document.getElementById('modalDate').innerText = row[globalMap.date] || "";
            document.getElementById('modalCommentContent').innerText = `Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ù…Ø¯Ø±Ø¨: \n${iC}\n\nÙ…Ù‚ØªØ±Ø­ Ø§Ù„Ø¯ÙˆØ±Ø©: \n${cC}`;
            document.getElementById('commentModal').style.display = 'flex';
        }

        document.getElementById('userSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.comment-card').forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                card.style.display = name.includes(term) ? 'block' : 'none';
            });
        });

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>