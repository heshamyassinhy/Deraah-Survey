<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø¯Ø±Ø¹Ù‡ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink-primary: #ff4d7d;
            --pink-glass: rgba(255, 182, 193, 0.25);
            --white-glass: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #fff0f3;
            background-image: 
                radial-gradient(circle at 20% 20%, #ffc1d1 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, #ff85a2 0%, transparent 40%);
            min-height: 100vh;
            color: #4a1d24;
            overflow-x: hidden;
        }

        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(255, 77, 125, 0.1);
        }

        .clickable-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .clickable-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.6);
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #8a5a62;
            border-radius: 12px;
            margin: 4px 0;
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, rgba(255, 77, 125, 0.8) 0%, rgba(255, 107, 149, 0.9) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 77, 125, 0.3);
        }

        .custom-button {
            background: linear-gradient(135deg, #ff6b95 0%, #ff4d7d 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px -10px rgba(255, 77, 125, 0.5);
        }

        .custom-button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(255, 192, 203, 0.4);
            backdrop-filter: blur(10px);
            align-items: center; justify-content: center; padding: 20px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 77, 125, 0.3); border-radius: 10px; }

        .stat-icon {
            background: rgba(255, 77, 125, 0.1);
            color: #ff4d7d;
        }

        .missing-tag {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
            font-size: 11px;
            padding: 2px 10px;
            border-radius: 99px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .logo-box {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-box img {
            height: 45px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 77, 125, 0.2);
            transition: all 0.3s ease;
        }

        .input-glass:focus {
            background: white;
            border-color: #ff4d7d;
            box-shadow: 0 0 0 4px rgba(255, 77, 125, 0.1);
        }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <aside class="glass-sidebar w-72 fixed h-full hidden lg:block z-50 overflow-y-auto">
        <div class="p-8">
            <div class="logo-box mb-12">
                <img src="D.png" alt="Logo 1" onerror="this.src='https://placehold.co/50x50/ff4d7d/white?text=D'">
                <img src="D1.png" alt="Logo 2" onerror="this.src='https://placehold.co/50x50/ff4d7d/white?text=D1'">
                <div class="mr-2">
                    <h1 class="text-2xl font-black text-[#ff4d7d] tracking-tighter">Ø¯Ø±Ø¹Ù‡</h1>
                    <p class="text-[9px] text-pink-400 tracking-[0.2em] font-bold">ACADEMY</p>
                </div>
            </div>
            
            <nav class="space-y-8">
                <div>
                    <p class="text-[10px] text-pink-500 font-black px-2 mb-4 uppercase tracking-widest opacity-60">Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <div id="fileListContainer" class="space-y-2">
                        <button onclick="switchToFiles('all')" id="btn-all" class="sidebar-item active w-full text-right px-4 py-3 text-sm flex items-center justify-between font-bold">
                            <span>ğŸ“‚ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</span>
                        </button>
                    </div>
                </div>

                <div>
                    <p class="text-[10px] text-pink-500 font-black px-2 mb-4 uppercase tracking-widest opacity-60">Ø§Ù„ØªØ­ÙƒÙ…</p>
                    <button onclick="exportReport()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-white/60 hover:bg-white text-sm text-pink-600 font-bold transition-all border border-pink-100">
                        ğŸ“Š ØªØµØ¯ÙŠØ± Excel
                    </button>
                    <button onclick="showExcluded()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-amber-50/60 hover:bg-amber-100/80 text-sm text-amber-700 font-bold transition-all mt-2 border border-amber-100">
                        ğŸš« Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†
                    </button>
                </div>

                <div>
                    <p class="text-[10px] text-pink-500 font-black px-2 mb-2 uppercase tracking-widest opacity-60">Ø¨Ø­Ø«</p>
                    <input type="text" id="userSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨..." class="w-full input-glass rounded-xl px-4 py-3 text-xs focus:outline-none">
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 lg:mr-72 p-6 lg:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
                <h2 id="currentViewTitle" class="text-4xl font-black text-[#4a1d24]">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h2>
                <p class="text-pink-500 mt-2 font-bold flex items-center gap-2">
                    <span class="w-2.5 h-2.5 bg-pink-500 rounded-full shadow-[0_0_10px_rgba(255,77,125,0.8)]"></span>
                    Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </p>
            </div>
            <div class="flex gap-4 w-full md:w-auto">
                <label for="fileInput" class="custom-button px-10 py-4 rounded-2xl font-black cursor-pointer text-center whitespace-nowrap">
                    Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
                </label>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv" multiple>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass-card p-6 border-b-4 border-b-pink-400/50">
                <p class="text-pink-500 text-xs font-black mb-1 uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯</p>
                <h3 id="totalResponses" class="text-4xl font-black text-[#4a1d24]">0</h3>
            </div>
            <div onclick="showCategoryDetails('instructor')" class="glass-card clickable-card p-6 border-b-4 border-b-[#ff4d7d]">
                <p class="text-pink-500 text-xs font-black mb-1 uppercase">ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨</p>
                <h3 id="instructorScore" class="text-4xl font-black text-[#ff4d7d]">0%</h3>
                <p class="text-[9px] text-pink-400 mt-2 font-bold">Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙØ§ØµÙŠÙ„</p>
            </div>
            <div onclick="showCategoryDetails('content')" class="glass-card clickable-card p-6 border-b-4 border-b-blue-400">
                <p class="text-pink-500 text-xs font-black mb-1 uppercase">Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
                <h3 id="contentScore" class="text-4xl font-black text-blue-600">0%</h3>
                <p class="text-[9px] text-blue-400 mt-2 font-bold">Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙØ§ØµÙŠÙ„</p>
            </div>
            <div onclick="showCategoryDetails('ux')" class="glass-card clickable-card p-6 border-b-4 border-b-amber-400">
                <p class="text-pink-500 text-xs font-black mb-1 uppercase">Ø±Ø¶Ø§ Ø§Ù„Ù…Ù†ØµØ©</p>
                <h3 id="uxScore" class="text-4xl font-black text-amber-600">0%</h3>
                <p class="text-[9px] text-amber-400 mt-2 font-bold">Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙØ§ØµÙŠÙ„</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-10">
            <div class="glass-card p-8 lg:col-span-2 min-h-[450px] flex flex-col">
                <h4 class="font-black text-lg mb-8 text-[#4a1d24] border-r-4 border-pink-500 pr-3">Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…</h4>
                <div class="relative flex-1 flex items-center justify-center">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-8 lg:col-span-3 min-h-[450px] flex flex-col">
                <h4 class="font-black text-lg mb-6 flex justify-between text-[#4a1d24] border-r-4 border-blue-500 pr-3">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h4>
                <div id="detailedAnalysisList" class="space-y-3 flex-1 overflow-y-auto pr-2">
                    <div class="flex flex-col items-center justify-center h-full opacity-20">
                        <span class="text-6xl mb-4">ğŸ“Š</span>
                        <p class="font-bold">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4 mb-8">
            <div class="h-px flex-1 bg-pink-200"></div>
            <h4 class="text-2xl font-black text-[#4a1d24] px-4">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</h4>
            <div class="h-px flex-1 bg-pink-200"></div>
            <select id="commentSort" class="input-glass rounded-xl px-4 py-2 text-xs font-bold text-[#4a1d24] outline-none">
                <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="old">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="long">Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹</option>
            </select>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="flex flex-col gap-4">
                <h5 class="font-black text-pink-600 flex items-center gap-2">
                    <span class="w-2 h-6 bg-pink-500 rounded-full"></span>
                    ØªÙˆØµÙŠØ§Øª ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø¨
                    <span id="instCommCount" class="bg-pink-100 text-pink-500 px-2 rounded-md text-xs">0</span>
                </h5>
                <div id="instructorComments" class="space-y-4 max-h-[500px] overflow-y-auto pl-2"></div>
            </div>
            <div class="flex flex-col gap-4">
                <h5 class="font-black text-blue-600 flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                    ØªÙˆØµÙŠØ§Øª ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    <span id="courseCommCount" class="bg-blue-100 text-blue-500 px-2 rounded-md text-xs">0</span>
                </h5>
                <div id="courseComments" class="space-y-4 max-h-[500px] overflow-y-auto pl-2"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="categoryDetailModal" class="modal">
        <div class="glass-card max-w-2xl w-full p-8 relative">
            <button onclick="closeModal('categoryDetailModal')" class="absolute top-6 left-6 text-pink-500 hover:rotate-90 transition-transform text-3xl font-black">Ã—</button>
            <h3 id="catModalTitle" class="text-2xl font-black mb-2 text-[#4a1d24]">...</h3>
            <p id="catModalDesc" class="text-sm text-pink-500 font-bold mb-8 italic">ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</p>
            <div id="catModalList" class="space-y-4 max-h-[450px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="excludedModal" class="modal">
        <div class="glass-card max-w-2xl w-full p-8 relative">
            <button onclick="closeModal('excludedModal')" class="absolute top-6 left-6 text-pink-500 hover:rotate-90 transition-transform text-3xl font-black">Ã—</button>
            <h3 class="text-2xl font-black mb-2 text-amber-600">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†</h3>
            <p class="text-xs text-amber-800/60 font-bold mb-8 italic">ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù„Ø¹Ø¯Ù… Ø§Ø³ØªÙƒÙ…Ø§Ù„Ù‡Ù… ØªÙ‚ÙŠÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.</p>
            <div id="excludedList" class="space-y-4 max-h-[450px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="commentModal" class="modal">
        <div class="glass-card max-w-xl w-full p-10 relative">
            <button onclick="closeModal('commentModal')" class="absolute top-6 left-6 text-pink-500 hover:rotate-90 transition-transform text-4xl font-black">Ã—</button>
            <div class="flex items-center gap-6 mb-10">
                <div class="w-20 h-20 bg-gradient-to-br from-pink-400 to-pink-600 rounded-3xl flex items-center justify-center shadow-xl">
                    <span class="text-3xl text-white">ğŸ‘¤</span>
                </div>
                <div>
                    <h3 id="modalUserName" class="text-2xl font-black text-[#4a1d24]">...</h3>
                    <p id="modalDate" class="text-pink-500 font-bold text-sm mt-1"></p>
                </div>
            </div>
            <div class="bg-white/80 p-8 rounded-[32px] border border-pink-100 shadow-inner">
                <p id="modalCommentContent" class="text-[#4a1d24] text-xl font-medium leading-loose whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <div id="lowScoresModal" class="modal">
        <div class="glass-card max-w-lg w-full p-8 relative">
            <button onclick="closeModal('lowScoresModal')" class="absolute top-6 left-6 text-pink-500 hover:rotate-90 transition-transform text-3xl font-black">Ã—</button>
            <h3 id="lowScoreTitle" class="text-2xl font-black mb-8 text-[#4a1d24] border-r-8 border-red-500 pr-4">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©</h3>
            <div id="lowScoresList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        let mainChart;
        let sessions = {}; 
        let currentSessionId = 'all';
        let allCleanDataCombined = [];
        let allExcludedCombined = [];
        let currentSearchTerm = "";

        const columnKeywords = {
            name: ["name", "Ø§Ù„Ø§Ø³Ù…"],
            ux: ["Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡", "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"],
            hours: ["Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©"],
            vids: ["Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª", "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰"],
            book: ["ÙƒØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±Ø©"],
            assets: ["Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"],
            exam: ["ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"],
            apply: ["ØªØ·Ø¨ÙŠÙ‚ Ù…Ø§ ØªØ¹Ù„Ù…ØªÙ‡"],
            methods: ["Ø§Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙÙ‡", "Ø£Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙØ©", "Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø©"],
            clarity: ["ÙˆØ¶ÙˆØ­ Ø´Ø±Ø­ Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            voice: ["ØµÙˆØªÙ‡ Ø¨Ø´ÙƒÙ„ ÙØ¹Ø§Ù„"],
            link: ["Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"],
            recommend: ["ØªÙˆØµÙŠ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            improveCourse: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ø¯ÙˆØ±Ø§Øª"],
            improveInst: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ù…Ø¯Ø±Ø¨"],
            date: ["date", "Ø§Ù„ØªØ§Ø±ÙŠØ®"]
        };

        const instructorKeys = ['methods', 'clarity', 'voice', 'link', 'recommend'];
        const contentKeys = ['hours', 'vids', 'book', 'assets', 'exam', 'apply'];
        const allRatingKeys = ['ux', ...instructorKeys, ...contentKeys];

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            for (const file of files) { await processFile(file); }
            updateSidebar();
            switchToFiles('all');
        });

        document.getElementById('commentSort').addEventListener('change', renderComments);

        async function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (json.length < 2) { resolve(); return; }

                    const headers = json[0];
                    const dataRows = json.slice(1);
                    const map = {};
                    Object.keys(columnKeywords).forEach(key => { map[key] = findColumnIndex(headers, columnKeywords[key]); });

                    let cData = [];
                    let eUsers = [];

                    dataRows.forEach(row => {
                        let missingFromThisRow = [];
                        allRatingKeys.forEach(key => {
                            const idx = map[key];
                            if (idx !== -1) {
                                const val = row[idx];
                                if (val === undefined || val === null || val.toString().trim() === "" || val.toString() === "0") {
                                    missingFromThisRow.push(headers[idx] || key);
                                }
                            }
                        });

                        if (missingFromThisRow.length > 0) {
                            eUsers.push({ name: row[map.name] || "Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", row: row, fileName: file.name, missingQuestions: missingFromThisRow });
                        } else {
                            cData.push({ row, fileName: file.name });
                        }
                    });

                    sessions[file.name] = { cleanData: cData, excludedUsers: eUsers, headers: headers, globalMap: map };
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || "").toString().toLowerCase();
                if (keywords.some(kw => header.includes(kw.toLowerCase()))) return i;
            }
            return -1;
        }

        function updateSidebar() {
            const container = document.getElementById('fileListContainer');
            const allBtn = document.getElementById('btn-all');
            container.innerHTML = '';
            container.appendChild(allBtn);

            Object.keys(sessions).forEach(fileName => {
                const btn = document.createElement('button');
                btn.id = `btn-${fileName}`;
                btn.onclick = () => switchToFiles(fileName);
                btn.className = 'sidebar-item w-full text-right px-4 py-3 text-[11px] flex items-center font-bold hover:bg-white/40 transition-all truncate';
                btn.innerHTML = `ğŸ“„ ${fileName}`;
                container.appendChild(btn);
            });
        }

        function switchToFiles(id) {
            currentSessionId = id;
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${id}`);
            if (activeBtn) activeBtn.classList.add('active');

            if (id === 'all') {
                document.getElementById('currentViewTitle').innerText = "Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª";
                combineAllData();
            } else {
                document.getElementById('currentViewTitle').innerText = id.replace(/\.[^/.]+$/, "");
            }
            renderUI();
        }

        function combineAllData() {
            allCleanDataCombined = [];
            allExcludedCombined = [];
            Object.values(sessions).forEach(s => {
                allCleanDataCombined = allCleanDataCombined.concat(s.cleanData);
                allExcludedCombined = allExcludedCombined.concat(s.excludedUsers);
            });
        }

        function getDataContext() {
            if (currentSessionId === 'all') {
                const firstKey = Object.keys(sessions)[0];
                return { data: allCleanDataCombined, excluded: allExcludedCombined, globalMap: sessions[firstKey]?.globalMap || {}, headers: sessions[firstKey]?.headers || [] };
            } else {
                const s = sessions[currentSessionId];
                return { data: s.cleanData, excluded: s.excludedUsers, globalMap: s.globalMap, headers: s.headers };
            }
        }

        function calculateScore(targetData, keys) {
            let positive = 0, totalPossible = 0;
            targetData.forEach(item => {
                const mapToUse = sessions[item.fileName].globalMap;
                keys.forEach(key => {
                    const idx = mapToUse[key];
                    if (idx !== -1) { 
                        totalPossible++; 
                        const val = parseInt(item.row[idx]);
                        if (val >= 4) positive++; 
                    }
                });
            });
            return totalPossible > 0 ? ((positive / totalPossible) * 100).toFixed(1) : 0;
        }

        function renderUI() {
            const ctx = getDataContext();
            if (!ctx.data.length && !Object.keys(sessions).length) return;

            document.getElementById('totalResponses').innerText = ctx.data.length;
            document.getElementById('instructorScore').innerText = calculateScore(ctx.data, instructorKeys) + "%";
            document.getElementById('contentScore').innerText = calculateScore(ctx.data, contentKeys) + "%";
            document.getElementById('uxScore').innerText = calculateScore(ctx.data, ['ux']) + "%";

            if (mainChart) mainChart.destroy();
            mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Ø§Ù„Ù…Ø¯Ø±Ø¨', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'Ø§Ù„Ù…Ù†ØµØ©'],
                    datasets: [{
                        data: [calculateScore(ctx.data, instructorKeys), calculateScore(ctx.data, contentKeys), calculateScore(ctx.data, ['ux'])],
                        backgroundColor: ['#ff4d7d', '#3b82f6', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: { cutout: '75%', maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#4a1d24', font: { family: 'Cairo', size: 12, weight: '900' } } } } }
            });

            const list = document.getElementById('detailedAnalysisList');
            list.innerHTML = '';
            allRatingKeys.forEach(key => {
                const score = calculateScore(ctx.data, [key]);
                const title = ctx.headers[ctx.globalMap[key]] || key;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-white/50 rounded-2xl border border-white hover:bg-white transition-all shadow-sm';
                div.innerHTML = `
                    <div class="flex-1 ml-4 overflow-hidden text-right">
                        <p class="text-[11px] text-[#4a1d24] truncate font-black mb-1">${title}</p>
                        <div class="w-full bg-pink-100 h-2 rounded-full overflow-hidden">
                            <div class="h-full rounded-full ${score > 80 ? 'bg-pink-500' : 'bg-amber-500'}" style="width: ${score}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-black text-[#4a1d24] w-12 text-center">${score}%</span>
                        <button onclick="showLowScores('${key}', '${title}')" class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 transition-all text-[10px] font-black shadow-md shadow-pink-200">ÙØ­Øµ</button>
                    </div>`;
                list.appendChild(div);
            });
            renderComments();
        }

        function showCategoryDetails(type) {
            const ctx = getDataContext();
            let keys = [];
            let title = "";
            let color = "";

            if (type === 'instructor') { keys = instructorKeys; title = "ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨"; color = "bg-pink-500"; }
            else if (type === 'content') { keys = contentKeys; title = "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰"; color = "bg-blue-500"; }
            else { keys = ['ux']; title = "Ø±Ø¶Ø§ Ø§Ù„Ù…Ù†ØµØ©"; color = "bg-amber-500"; }

            document.getElementById('catModalTitle').innerText = title;
            const list = document.getElementById('catModalList');
            list.innerHTML = '';

            keys.forEach(key => {
                const score = calculateScore(ctx.data, [key]);
                const qText = ctx.headers[ctx.globalMap[key]] || key;
                const div = document.createElement('div');
                div.className = 'p-5 bg-white/70 rounded-2xl border border-white shadow-sm';
                div.innerHTML = `
                    <p class="text-xs font-bold text-[#4a1d24] mb-3 leading-relaxed">${qText}</p>
                    <div class="flex items-center gap-4">
                        <div class="flex-1 bg-gray-100 h-2 rounded-full overflow-hidden">
                            <div class="h-full ${color}" style="width: ${score}%"></div>
                        </div>
                        <span class="text-sm font-black text-[#4a1d24]">${score}%</span>
                    </div>`;
                list.appendChild(div);
            });

            document.getElementById('categoryDetailModal').style.display = 'flex';
        }

        function renderComments() {
            const ctx = getDataContext();
            const sortVal = document.getElementById('commentSort').value;
            const instEl = document.getElementById('instructorComments');
            const courseEl = document.getElementById('courseComments');
            instEl.innerHTML = ''; courseEl.innerHTML = '';
            
            let allComments = [];
            ctx.data.forEach(item => {
                const map = sessions[item.fileName].globalMap;
                const iC = item.row[map.improveInst];
                const cC = item.row[map.improveCourse];
                const uName = (item.row[map.name] || "").toString().toLowerCase();

                if (currentSearchTerm && !uName.includes(currentSearchTerm)) return;

                if (iC && iC.toString().trim().length > 1 && iC != "0") {
                    allComments.push({ text: iC.toString(), name: item.row[map.name], date: item.row[map.date], item, type: 'inst' });
                }
                if (cC && cC.toString().trim().length > 1 && cC != "0") {
                    allComments.push({ text: cC.toString(), name: item.row[map.name], date: item.row[map.date], item, type: 'course' });
                }
            });

            if (sortVal === 'new') allComments.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (sortVal === 'old') allComments.sort((a, b) => new Date(a.date) - new Date(b.date));
            else if (sortVal === 'long') allComments.sort((a, b) => b.text.length - a.text.length);

            allComments.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-6 bg-white/60 border border-white rounded-[24px] cursor-pointer hover:bg-white hover:border-pink-300 transition-all text-right shadow-sm group';
                div.innerHTML = `
                    <p class="text-sm text-[#4a1d24] font-medium leading-relaxed mb-4 line-clamp-3">${c.text}</p>
                    <div class="flex justify-between items-center border-t border-pink-100 pt-3">
                        <span class="text-[10px] text-pink-400 font-bold opacity-60 group-hover:opacity-100">${c.name}</span>
                        <span class="text-[9px] bg-pink-50 text-pink-500 px-2 py-1 rounded-md font-black">Ø§Ù„ØªÙØ§ØµÙŠÙ„ â”</span>
                    </div>`;
                div.onclick = () => openUserDetail(c.item);
                if (c.type === 'inst') instEl.appendChild(div); else courseEl.appendChild(div);
            });
            document.getElementById('instCommCount').innerText = instEl.childElementCount;
            document.getElementById('courseCommCount').innerText = courseEl.childElementCount;
        }

        function openUserDetail(item) {
            const map = sessions[item.fileName].globalMap;
            document.getElementById('modalUserName').innerText = item.row[map.name] || "Ù…ØªØ¯Ø±Ø¨";
            document.getElementById('modalDate').innerText = `${item.row[map.date] || ""} - ${item.fileName}`;
            const instImp = item.row[map.improveInst] || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
            const courseImp = item.row[map.improveCourse] || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
            document.getElementById('modalCommentContent').innerHTML = `<span class="text-pink-600 block mb-2 font-black">â— Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø¯Ø±Ø¨:</span>${instImp}<br><br><span class="text-blue-600 block mb-2 font-black">â— Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¯ÙˆØ±Ø©:</span>${courseImp}`;
            document.getElementById('commentModal').style.display = 'flex';
        }

        function showExcluded() {
            const ctx = getDataContext();
            const list = document.getElementById('excludedList');
            list.innerHTML = '';
            if (ctx.excluded.length === 0) {
                list.innerHTML = '<div class="text-center py-12 opacity-30 font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ¨Ø¹Ø¯ÙˆÙ†.</div>';
            } else {
                ctx.excluded.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-6 bg-white/60 rounded-3xl border border-white text-right shadow-sm';
                    const missingHtml = item.missingQuestions.map(q => `<span class="missing-tag m-1">${q}</span>`).join('');
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full font-black">Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©</span>
                            <div>
                                <p class="text-lg font-black text-[#4a1d24]">${item.name}</p>
                                <p class="text-[10px] text-pink-400 font-bold mt-1">${item.fileName}</p>
                            </div>
                        </div>
                        <div class="border-t border-white/80 pt-4">
                            <p class="text-[11px] text-[#4a1d24] mb-3 font-black">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ©:</p>
                            <div class="flex flex-wrap gap-2 justify-end">${missingHtml}</div>
                        </div>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('excludedModal').style.display = 'flex';
        }

        function showLowScores(key, title) {
            const ctx = getDataContext();
            const listEl = document.getElementById('lowScoresList');
            listEl.innerHTML = '';
            const lowScorers = ctx.data
                .map(item => ({ name: item.row[sessions[item.fileName].globalMap.name], val: parseInt(item.row[sessions[item.fileName].globalMap[key]]), item }))
                .filter(i => i.val > 0 && i.val <= 3)
                .sort((a, b) => a.val - b.val);

            if (lowScorers.length === 0) listEl.innerHTML = '<p class="text-center py-12 opacity-30 font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø³Ù„Ø¨ÙŠØ©.</p>';

            lowScorers.forEach(i => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-5 bg-white/70 rounded-[20px] border border-white cursor-pointer hover:bg-white transition-all shadow-sm';
                div.onclick = () => { closeModal('lowScoresModal'); openUserDetail(i.item); };
                div.innerHTML = `
                    <div class="text-right">
                        <p class="text-md font-black text-[#4a1d24]">${i.name}</p>
                        <p class="text-[10px] text-pink-500 font-bold">${i.item.fileName}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-red-400 font-bold">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                        <span class="bg-red-500 text-white w-10 h-10 flex items-center justify-center rounded-2xl font-black shadow-lg shadow-red-200">${i.val}</span>
                    </div>`;
                listEl.appendChild(div);
            });
            document.getElementById('lowScoreTitle').innerText = `${title}`;
            document.getElementById('lowScoresModal').style.display = 'flex';
        }

        function exportReport() {
            const ctx = getDataContext();
            if (ctx.data.length === 0) return;
            const fileNameToSave = currentSessionId === 'all' ? "Ù…Ø¬Ù…Ø¹_Ø§Ù„Ø¯ÙˆØ±Ø§Øª" : currentSessionId.replace(/\.[^/.]+$/, "");
            
            const wb = XLSX.utils.book_new();
            
            // 1. Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            const summaryData = [
                ["ØªÙ‚Ø±ÙŠØ± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡ Ù„Ù„ØªØ­Ù„ÙŠÙ„ - Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©"],
                ["Ø§Ù„Ø¯ÙˆØ±Ø©", fileNameToSave],
                ["ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±", new Date().toLocaleDateString('ar-SA')],
                [],
                ["Ø§Ù„Ù…Ø¹ÙŠØ§Ø±", "Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¶Ø§)"],
                ["ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨", document.getElementById('instructorScore').innerText],
                ["Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰", document.getElementById('contentScore').innerText],
                ["Ø±Ø¶Ø§ Ø§Ù„Ù…Ù†ØµØ©", document.getElementById('uxScore').innerText],
                ["Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", ctx.data.length]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©");

            // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± (ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙˆÙ†Ø³Ø¨ØªÙ‡)
            const analysisData = [
                ["ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ"],
                ["Ø§Ù„Ø³Ø¤Ø§Ù„ / Ø§Ù„Ù…Ø¹ÙŠØ§Ø±", "Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©"],
            ];
            
            allRatingKeys.forEach(key => {
                const score = calculateScore(ctx.data, [key]);
                const title = ctx.headers[ctx.globalMap[key]] || key;
                analysisData.push([title, score + "%"]);
            });

            const wsAnalysis = XLSX.utils.aoa_to_sheet(analysisData);
            XLSX.utils.book_append_sheet(wb, wsAnalysis, "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±");

            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØªØ­Ù„ÙŠÙ„_${fileNameToSave}.xlsx`);
        }

        document.getElementById('userSearch').addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase();
            renderComments();
        });

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>