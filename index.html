<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø¯Ø±Ø¹Ù‡ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 28px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        .sidebar {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .custom-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .sidebar-item {
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }
        .sidebar-item.active {
            background: rgba(16, 185, 129, 0.1);
            border-right-color: #10b981;
            color: #10b981;
        }
        select option {
            background: #1e293b;
            color: white;
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .missing-tag {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            display: inline-block;
        }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <aside class="sidebar w-72 fixed h-full hidden lg:block z-50 overflow-y-auto">
        <div class="p-8">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center font-bold text-white shadow-lg shadow-emerald-500/20 text-2xl">D</div>
                <div>
                    <h1 class="text-xl font-bold leading-none">Ø¯Ø±Ø¹Ù‡</h1>
                    <p class="text-[10px] text-emerald-500 tracking-widest mt-1">ACADEMY</p>
                </div>
            </div>
            
            <nav class="space-y-6">
                <div>
                    <p class="text-[10px] text-slate-500 font-bold px-4 mb-3 uppercase tracking-widest">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <div id="fileListContainer" class="space-y-1">
                        <button onclick="switchToFiles('all')" id="btn-all" class="sidebar-item active w-full text-right px-5 py-3 rounded-xl text-xs flex items-center justify-between">
                            <span>ğŸ“‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ø¹Ø±Ø¶ Ù…Ø¬Ù…Ø¹)</span>
                        </button>
                    </div>
                </div>

                <div>
                    <p class="text-[10px] text-slate-500 font-bold px-4 mb-3 uppercase tracking-widest">Ø§Ù„Ø£Ø¯ÙˆØ§Øª</p>
                    <button onclick="exportReport()" class="w-full flex items-center gap-3 px-5 py-3 rounded-xl bg-white/5 hover:bg-emerald-500/20 text-xs text-slate-300 transition-all text-right">
                        ğŸ“Š ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„
                    </button>
                    <button onclick="showExcluded()" class="w-full flex items-center gap-3 px-5 py-3 rounded-xl bg-white/5 hover:bg-amber-500/20 text-xs text-slate-300 transition-all text-right mt-2">
                        ğŸš« Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†
                    </button>
                </div>

                <div>
                    <p class="text-[10px] text-slate-500 font-bold px-4 mb-2 uppercase tracking-widest">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</p>
                    <input type="text" id="userSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-xs focus:outline-none focus:border-emerald-500 transition-all text-white">
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 lg:mr-72 p-6 lg:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
                <h2 id="currentViewTitle" class="text-3xl font-bold tracking-tight">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ø¹Ø±Ø¶ Ù…Ø¬Ù…Ø¹)</h2>
                <p class="text-slate-400 mt-2 flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
                </p>
            </div>
            <div class="flex gap-4 w-full md:w-auto">
                <label for="fileInput" class="custom-button w-full md:w-auto px-8 py-4 rounded-2xl font-bold cursor-pointer flex items-center justify-center gap-3 text-white shadow-lg shadow-emerald-500/20">
                    Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (Ù…ØªØ¹Ø¯Ø¯)
                </label>
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv" multiple>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</p><h3 id="totalResponses" class="text-4xl font-black">0</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">ÙƒÙØ§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨</p><h3 id="instructorScore" class="text-4xl font-black text-emerald-400">0%</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p><h3 id="contentScore" class="text-4xl font-black text-blue-400">0%</h3></div>
            <div class="glass-card p-7"><p class="text-slate-400 text-sm mb-2">Ø±Ø¶Ø§ Ø§Ù„Ù…Ù†ØµØ©</p><h3 id="uxScore" class="text-4xl font-black text-amber-500">0%</h3></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 items-stretch">
            <div class="glass-card p-8 min-h-[500px]">
                <h4 class="font-bold text-lg mb-8">Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…</h4>
                <div class="relative flex-1 flex items-center justify-center">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-8 min-h-[500px]">
                <h4 class="font-bold text-lg mb-6 flex justify-between">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span>ğŸ”</span></h4>
                <div id="detailedAnalysisList" class="space-y-3 flex-1 overflow-y-auto pr-2">
                    <p class="text-center opacity-20 mt-20">ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</p>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <h4 class="text-xl font-bold">Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
            <div class="flex items-center gap-3">
                <span class="text-xs text-slate-500">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</span>
                <select id="commentSort" class="bg-slate-800 border border-white/10 rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-emerald-500 text-white cursor-pointer hover:bg-slate-700 transition-colors">
                    <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                    <option value="old">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
                    <option value="long">Ø§Ù„Ø£Ø·ÙˆÙ„</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card p-8">
                <h4 class="text-emerald-400 font-bold mb-6 flex justify-between">ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø¨ <span id="instCommCount" class="text-xs opacity-50 font-normal pt-1">0</span></h4>
                <div id="instructorComments" class="space-y-4 max-h-[450px] overflow-y-auto pl-2"></div>
            </div>
            <div class="glass-card p-8">
                <h4 class="text-blue-400 font-bold mb-6 flex justify-between">ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© <span id="courseCommCount" class="text-xs opacity-50 font-normal pt-1">0</span></h4>
                <div id="courseComments" class="space-y-4 max-h-[450px] overflow-y-auto pl-2"></div>
            </div>
        </div>
    </main>

    <!-- Excluded Modal -->
    <div id="excludedModal" class="modal">
        <div class="glass-card max-w-2xl w-full p-8 relative">
            <button onclick="closeModal('excludedModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-2xl">Ã—</button>
            <h3 class="text-xl font-bold mb-2 text-amber-500">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†</h3>
            <p class="text-xs text-slate-400 mb-6">ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø£ÙŠ Ù…ØªØ¯Ø±Ø¨ Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø¯Ø±Ø¬Ø© 0 Ø£Ùˆ ÙØ§Ø±Øº).</p>
            <div id="excludedList" class="space-y-4 max-h-[450px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="commentModal" class="modal">
        <div class="glass-card max-w-xl w-full p-10 relative">
            <button onclick="closeModal('commentModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-3xl">Ã—</button>
            <div class="flex items-center gap-5 mb-8 text-right">
                <div id="modalUserAvatar" class="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center font-bold text-2xl">ğŸ‘¤</div>
                <div><h3 id="modalUserName" class="text-2xl font-bold">...</h3><p id="modalDate" class="text-emerald-500 text-sm"></p></div>
            </div>
            <div class="bg-white/5 p-8 rounded-3xl border border-white/10">
                <p id="modalCommentContent" class="text-slate-200 text-lg leading-relaxed whitespace-pre-wrap text-right"></p>
            </div>
        </div>
    </div>

    <div id="lowScoresModal" class="modal">
        <div class="glass-card max-w-lg w-full p-8 relative text-right">
            <button onclick="closeModal('lowScoresModal')" class="absolute top-6 left-6 text-slate-500 hover:text-white text-3xl">Ã—</button>
            <h3 id="lowScoreTitle" class="text-xl font-bold mb-6 text-emerald-400">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¨ÙŠØ§Øª (1 - 3)</h3>
            <div id="lowScoresList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        let mainChart;
        let sessions = {}; 
        let currentSessionId = 'all';
        let allCleanDataCombined = [];
        let allExcludedCombined = [];
        let currentSearchTerm = "";

        const columnKeywords = {
            name: ["name", "Ø§Ù„Ø§Ø³Ù…"],
            ux: ["Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡", "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"],
            hours: ["Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©"],
            vids: ["Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª", "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰"],
            book: ["ÙƒØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±Ø©"],
            assets: ["Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"],
            exam: ["ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"],
            apply: ["ØªØ·Ø¨ÙŠÙ‚ Ù…Ø§ ØªØ¹Ù„Ù…ØªÙ‡"],
            methods: ["Ø§Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙÙ‡", "Ø£Ø³Ø§Ù„ÙŠØ¨ Ù…Ø®ØªÙ„ÙØ©", "Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø©"],
            clarity: ["ÙˆØ¶ÙˆØ­ Ø´Ø±Ø­ Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            voice: ["ØµÙˆØªÙ‡ Ø¨Ø´ÙƒÙ„ ÙØ¹Ø§Ù„"],
            link: ["Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"],
            recommend: ["ØªÙˆØµÙŠ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø¨"],
            improveCourse: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ø¯ÙˆØ±Ø§Øª"],
            improveInst: ["Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªÙˆØµÙŠ Ø¨Ù‡Ø§ Ù„Ù„Ù…Ø¯Ø±Ø¨"],
            date: ["date", "Ø§Ù„ØªØ§Ø±ÙŠØ®"]
        };

        const instructorKeys = ['methods', 'clarity', 'voice', 'link', 'recommend'];
        const contentKeys = ['hours', 'vids', 'book', 'assets', 'exam', 'apply'];
        const allRatingKeys = ['ux', ...instructorKeys, ...contentKeys];

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            for (const file of files) { await processFile(file); }
            updateSidebar();
            switchToFiles('all');
        });

        document.getElementById('commentSort').addEventListener('change', renderComments);

        async function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (json.length < 2) { resolve(); return; }

                    const headers = json[0];
                    const dataRows = json.slice(1);
                    const map = {};
                    Object.keys(columnKeywords).forEach(key => { map[key] = findColumnIndex(headers, columnKeywords[key]); });

                    let cData = [];
                    let eUsers = [];

                    dataRows.forEach(row => {
                        let missingFromThisRow = [];
                        allRatingKeys.forEach(key => {
                            const idx = map[key];
                            if (idx !== -1) {
                                const val = row[idx];
                                if (val === undefined || val === null || val.toString().trim() === "" || val.toString() === "0") {
                                    missingFromThisRow.push(headers[idx] || key);
                                }
                            }
                        });

                        if (missingFromThisRow.length > 0) {
                            eUsers.push({ 
                                name: row[map.name] || "Ù…ØªØ¯Ø±Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", 
                                row: row, 
                                fileName: file.name,
                                missingQuestions: missingFromThisRow 
                            });
                        } else {
                            cData.push({ row, fileName: file.name });
                        }
                    });

                    sessions[file.name] = { cleanData: cData, excludedUsers: eUsers, headers: headers, globalMap: map };
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || "").toString().toLowerCase();
                if (keywords.some(kw => header.includes(kw.toLowerCase()))) return i;
            }
            return -1;
        }

        function updateSidebar() {
            const container = document.getElementById('fileListContainer');
            const allBtn = document.getElementById('btn-all');
            container.innerHTML = '';
            container.appendChild(allBtn);

            Object.keys(sessions).forEach(fileName => {
                const btn = document.createElement('button');
                btn.id = `btn-${fileName}`;
                btn.onclick = () => switchToFiles(fileName);
                btn.className = 'sidebar-item w-full text-right px-5 py-3 rounded-xl text-[10px] flex items-center justify-between hover:bg-white/5 text-slate-400 truncate';
                btn.innerHTML = `<span>ğŸ“„ ${fileName}</span>`;
                container.appendChild(btn);
            });
        }

        function switchToFiles(id) {
            currentSessionId = id;
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${id}`);
            if (activeBtn) activeBtn.classList.add('active');

            if (id === 'all') {
                document.getElementById('currentViewTitle').innerText = "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ø¹Ø±Ø¶ Ù…Ø¬Ù…Ø¹)";
                combineAllData();
            } else {
                document.getElementById('currentViewTitle').innerText = id;
            }
            renderUI();
        }

        function combineAllData() {
            allCleanDataCombined = [];
            allExcludedCombined = [];
            Object.values(sessions).forEach(s => {
                allCleanDataCombined = allCleanDataCombined.concat(s.cleanData);
                allExcludedCombined = allExcludedCombined.concat(s.excludedUsers);
            });
        }

        function getDataContext() {
            if (currentSessionId === 'all') {
                const firstKey = Object.keys(sessions)[0];
                return { 
                    data: allCleanDataCombined, 
                    excluded: allExcludedCombined, 
                    globalMap: sessions[firstKey]?.globalMap || {},
                    headers: sessions[firstKey]?.headers || [] 
                };
            } else {
                const s = sessions[currentSessionId];
                return { data: s.cleanData, excluded: s.excludedUsers, globalMap: s.globalMap, headers: s.headers };
            }
        }

        function calculateScore(targetData, keys) {
            let positive = 0, totalPossible = 0;
            targetData.forEach(item => {
                const mapToUse = sessions[item.fileName].globalMap;
                keys.forEach(key => {
                    const idx = mapToUse[key];
                    if (idx !== -1) { 
                        totalPossible++; 
                        const val = parseInt(item.row[idx]);
                        if (val >= 4) positive++; 
                    }
                });
            });
            return totalPossible > 0 ? ((positive / totalPossible) * 100).toFixed(1) : 0;
        }

        function renderUI() {
            const ctx = getDataContext();
            if (!ctx.data.length && !Object.keys(sessions).length) return;

            document.getElementById('totalResponses').innerText = ctx.data.length;
            document.getElementById('instructorScore').innerText = calculateScore(ctx.data, instructorKeys) + "%";
            document.getElementById('contentScore').innerText = calculateScore(ctx.data, contentKeys) + "%";
            document.getElementById('uxScore').innerText = calculateScore(ctx.data, ['ux']) + "%";

            if (mainChart) mainChart.destroy();
            mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Ø§Ù„Ù…Ø¯Ø±Ø¨', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'Ø§Ù„Ù…Ù†ØµØ©'],
                    datasets: [{
                        data: [
                            calculateScore(ctx.data, instructorKeys), 
                            calculateScore(ctx.data, contentKeys), 
                            calculateScore(ctx.data, ['ux'])
                        ],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: { 
                    cutout: '70%', 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: 'Cairo', size: 11 } } } 
                    } 
                }
            });

            const list = document.getElementById('detailedAnalysisList');
            list.innerHTML = '';
            allRatingKeys.forEach(key => {
                const score = calculateScore(ctx.data, [key]);
                const title = ctx.headers[ctx.globalMap[key]] || key;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-all';
                div.innerHTML = `
                    <div class="flex-1 ml-4 overflow-hidden text-right">
                        <p class="text-[10px] text-slate-400 truncate">${title}</p>
                        <div class="w-full bg-white/10 h-1 rounded-full mt-2">
                            <div class="h-full rounded-full ${score > 80 ? 'bg-emerald-500' : 'bg-amber-500'}" style="width: ${score}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold">${score}%</span>
                        <button onclick="showLowScores('${key}', '${title}')" class="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500 hover:text-white transition-all text-[10px]">ÙØ­Øµ</button>
                    </div>`;
                list.appendChild(div);
            });
            renderComments();
        }

        function renderComments() {
            const ctx = getDataContext();
            const sortVal = document.getElementById('commentSort').value;
            const instEl = document.getElementById('instructorComments');
            const courseEl = document.getElementById('courseComments');
            instEl.innerHTML = ''; courseEl.innerHTML = '';
            
            let allComments = [];
            ctx.data.forEach(item => {
                const map = sessions[item.fileName].globalMap;
                const iC = item.row[map.improveInst];
                const cC = item.row[map.improveCourse];
                const uName = (item.row[map.name] || "").toString().toLowerCase();

                if (currentSearchTerm && !uName.includes(currentSearchTerm)) return;

                if (iC && iC.toString().trim().length > 1 && iC != "0") {
                    allComments.push({ text: iC.toString(), name: item.row[map.name], date: item.row[map.date], item, type: 'inst' });
                }
                if (cC && cC.toString().trim().length > 1 && cC != "0") {
                    allComments.push({ text: cC.toString(), name: item.row[map.name], date: item.row[map.date], item, type: 'course' });
                }
            });

            if (sortVal === 'new') allComments.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (sortVal === 'old') allComments.sort((a, b) => new Date(a.date) - new Date(b.date));
            else if (sortVal === 'long') allComments.sort((a, b) => b.text.length - a.text.length);

            allComments.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-5 bg-white/5 border border-white/5 rounded-2xl cursor-pointer hover:border-emerald-500/40 transition-all text-right';
                div.innerHTML = `
                    <p class="text-xs text-slate-300 line-clamp-2">${c.text}</p>
                    <div class="flex justify-between mt-3 opacity-40 text-[9px]">
                        <span>${c.name} â€¢ ${c.item.fileName}</span>
                        <span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                    </div>`;
                div.onclick = () => openUserDetail(c.item);
                if (c.type === 'inst') instEl.appendChild(div); else courseEl.appendChild(div);
            });
            document.getElementById('instCommCount').innerText = instEl.childElementCount;
            document.getElementById('courseCommCount').innerText = courseEl.childElementCount;
        }

        function showExcluded() {
            const ctx = getDataContext();
            const list = document.getElementById('excludedList');
            list.innerHTML = '';
            if (ctx.excluded.length === 0) {
                list.innerHTML = '<div class="text-center py-10 opacity-30">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ÙˆÙ† Ù…Ø³ØªØ¨Ø¹Ø¯ÙˆÙ†.</div>';
            } else {
                ctx.excluded.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-5 bg-white/5 rounded-2xl border border-white/5 text-right';
                    const missingHtml = item.missingQuestions.map(q => `<span class="missing-tag m-1">${q}</span>`).join('');
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-amber-500 text-[10px] font-bold bg-amber-500/10 px-2 py-1 rounded">Ø¥Ø¬Ø§Ø¨Ø© Ù†Ø§Ù‚ØµØ©</span>
                            <div class="text-right">
                                <p class="text-sm font-bold text-slate-200">${item.name}</p>
                                <p class="text-[9px] text-slate-500 mt-1">Ø§Ù„Ù…Ù„Ù: ${item.fileName}</p>
                            </div>
                        </div>
                        <div class="border-t border-white/5 pt-3">
                            <p class="text-[10px] text-slate-500 mb-2 font-bold">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§:</p>
                            <div class="flex flex-wrap gap-1 justify-end">${missingHtml}</div>
                        </div>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('excludedModal').style.display = 'flex';
        }

        function showLowScores(key, title) {
            const ctx = getDataContext();
            const listEl = document.getElementById('lowScoresList');
            listEl.innerHTML = '';
            const lowScorers = ctx.data
                .map(item => ({ 
                    name: item.row[sessions[item.fileName].globalMap.name], 
                    val: parseInt(item.row[sessions[item.fileName].globalMap[key]]), 
                    item 
                }))
                .filter(i => i.val > 0 && i.val <= 3)
                .sort((a, b) => a.val - b.val);

            if (lowScorers.length === 0) listEl.innerHTML = '<p class="text-center py-10 opacity-40">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±.</p>';

            lowScorers.forEach(i => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition-colors';
                div.onclick = () => { closeModal('lowScoresModal'); openUserDetail(i.item); };
                div.innerHTML = `
                    <div class="text-right">
                        <p class="text-sm">${i.name}</p>
                        <p class="text-[9px] opacity-40">${i.item.fileName}</p>
                    </div>
                    <span class="bg-red-500/20 text-red-500 px-3 py-1 rounded-lg font-bold">${i.val}</span>`;
                listEl.appendChild(div);
            });
            document.getElementById('lowScoreTitle').innerText = `ØªØ­Ù„ÙŠÙ„: ${title}`;
            document.getElementById('lowScoresModal').style.display = 'flex';
        }

        function openUserDetail(item) {
            const map = sessions[item.fileName].globalMap;
            document.getElementById('modalUserName').innerText = item.row[map.name] || "Ù…ØªØ¯Ø±Ø¨";
            document.getElementById('modalDate').innerText = `${item.row[map.date] || ""} (${item.fileName})`;
            const instImp = item.row[map.improveInst] || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
            const courseImp = item.row[map.improveCourse] || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
            document.getElementById('modalCommentContent').innerText = `ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø¯Ø±Ø¨:\n${instImp}\n\nğŸ“– Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¯ÙˆØ±Ø©:\n${courseImp}`;
            document.getElementById('commentModal').style.display = 'flex';
        }

        function exportReport() {
            const ctx = getDataContext();
            if (ctx.data.length === 0) return;
            
            const fileNameToSave = currentSessionId === 'all' ? "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª" : currentSessionId.replace(/\.[^/.]+$/, "");
            const wb = XLSX.utils.book_new();
            
            // 1. ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ
            const summaryData = [
                ["ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø¯Ø±Ø¹Ù‡"],
                ["Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© / Ø§Ù„Ù†Ø·Ø§Ù‚", fileNameToSave],
                ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† (Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„Ø©)", ctx.data.length],
                ["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ† (Ø±Ø¯ÙˆØ¯ Ù†Ø§Ù‚ØµØ©)", ctx.excluded.length],
                ["ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±", new Date().toLocaleString('ar-SA')],
                [],
                ["Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©"],
                ["ÙƒÙØ§Ø¡Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø¨", document.getElementById('instructorScore').innerText],
                ["Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©", document.getElementById('contentScore').innerText],
                ["Ù…Ø¯Ù‰ Ø±Ø¶Ø§ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¹Ù† Ø§Ù„Ù…Ù†ØµØ©", document.getElementById('uxScore').innerText]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Ù…Ù„Ø®Øµ Ø¹Ø§Ù…");

            // 2. ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©
            const detailData = [
                ["Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†"],
                ["Ø§Ù„Ø³Ø¤Ø§Ù„ / Ø§Ù„Ù…Ø¹ÙŠØ§Ø±", "Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¶Ø§ (4-5)"]
            ];
            
            allRatingKeys.forEach(key => {
                const score = calculateScore(ctx.data, [key]);
                const title = ctx.headers[ctx.globalMap[key]] || key;
                detailData.push([title, score + "%"]);
            });
            
            const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, wsDetail, "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©");

            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_${fileNameToSave}.xlsx`);
        }

        document.getElementById('userSearch').addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase();
            renderComments();
        });

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>